#!/bin/env bash

set -e -o pipefail -u

trap 'echo "The script exited with error $? on line $LINENO"' ERR

cd "${0%/*}"

OS=${OS:-$(uname -s)}
STALWART_BASE=${STALWART_BASE:-/opt/stalwart-mail}
## Prevent path expansion on MSYS2/MINGW environments
export MSYS2_ENV_CONV_EXCL='STALWART_BASE'
export STALWART_BASE

if ! type ./stalwart-install &>/dev/null; then
  TAG=${TAG:-$(curl -s https://api.github.com/repos/stalwartlabs/mail-server/releases/latest | yq -r '.tag_name')}
  case $OS in
    Linux)
      set -x
      curl -L "https://github.com/stalwartlabs/mail-server/releases/download/$TAG/stalwart-install-x86_64-unknown-linux-gnu.tar.gz" | tar -xzvf -
      { set +x; } 2>/dev/null
      ;;
    Darwin)
      set -x
      curl -L "https://github.com/stalwartlabs/mail-server/releases/download/$TAG/stalwart-install-x86_64-apple-darwin.tar.gz" | tar -xzvf -
      { set +x; } 2>/dev/null
      ;;
    MINGW* | MSYS* | CYGWIN* | Windows_NT)
      temp_file=$(mktemp)
      set -x
      curl -L "https://github.com/stalwartlabs/mail-server/releases/download/$TAG/stalwart-install-x86_64-pc-windows-msvc.zip" -o "$temp_file"
      unzip -o "$temp_file"
      rm -fr "$temp_file"
      { set +x; } 2>/dev/null
      ;;
    *)
      echo "Unsupported OS: $OS"
      exit 1
      ;;
  esac
fi

CONFIG_DIR=config
STALWART_CONFIG_DIR="$CONFIG_DIR/etc"

## Cleanup
rm -fr "$CONFIG_DIR"
mkdir -p "$CONFIG_DIR"

## Run installer
./stalwart-install --component all-in-one --path "$STALWART_CONFIG_DIR/.." --docker

## Get selected store
STALWART_DEFAULT_STORE=$(yq '.macros.default_store' "$STALWART_CONFIG_DIR/config.toml")

## Fix paths in toml files
sed -i -E "s,$STALWART_CONFIG_DIR/\.\.,$STALWART_BASE," "$STALWART_CONFIG_DIR/config.toml"

## Set TLS cert/key paths to use autogenerated certs by cert-manager that are mounted from the stalwart-tls secret
sed -i -E \
  -e "s,(^cert\s*=\s*\").+,\1file://$STALWART_BASE/etc/certs/tls.crt\"," \
  -e "s,(^private-key\s*=\s*\").+,\1file://$STALWART_BASE/etc/certs/tls.key\"," \
  "$STALWART_CONFIG_DIR/common/tls.toml"

## Enable stdout logging
sed -i -E -e 's,^([^#]),#\1,g' -e '5,8s/^#//' "$STALWART_CONFIG_DIR/common/tracing.toml"

## Replace S3 credentials with env vars
sed -i -E \
  -e 's,^(access-key\s*=\s*).+,\1\!ACCESS_KEY_ID,' \
  -e 's,^(secret-key\s*=\s*).+,\1\!SECRET_ACCESS_KEY,' \
  "$STALWART_CONFIG_DIR/store/s3.toml"

## Cleanup
rm -fr \
    "${CONFIG_DIR:?}/bin" \
    "${CONFIG_DIR:?}/logs" \
    "${CONFIG_DIR:?}/queue" \
    "${CONFIG_DIR:?}/reports" \
    "$STALWART_CONFIG_DIR/acme/" \
    "$STALWART_CONFIG_DIR/certs/" \
    "$STALWART_CONFIG_DIR/spamfilter/"

(
  cd "$STALWART_CONFIG_DIR";
  find ./store -type f ! -name "$STALWART_DEFAULT_STORE.toml" ! -name 's3.toml' -print0 | while IFS= read -r -d '' file; do
    sed -i "/$(basename "$file")/d" config.toml
    rm -f "$file"
  done
)

SQLITE_FILES=$(
  cd "$CONFIG_DIR";
  find "data" -name '*.sqlite3' -exec gzip -9 {} \;
  find "data" -name '*.sqlite3.gz' -printf '      - %f=%p\n'
)
export SQLITE_FILES

DKIM_FILES=$(
  cd "$CONFIG_DIR";
  find "etc/dkim" -type f -printf '      - %f=%p\n'
)
export DKIM_FILES

CONFIG_FILES=$(
  cd "$CONFIG_DIR";
  find etc -name '*.toml' -printf '      - %P=%p\n' | sed -E 's,/([^=]+)=,_\1=,'
)
export CONFIG_FILES

OAUTH_KEY=$(yq -r '.oauth.key' "$STALWART_CONFIG_DIR/jmap/oauth.toml")
export OAUTH_KEY
## Remove oauth secret key from the config
sed -i -E 's,^(key\s*=\s*).+,\1\!OAUTH_KEY,' "$STALWART_CONFIG_DIR/jmap/oauth.toml"

## Generate config/kustomization.yaml
envsubst < templates/config-kustomization.yaml > "$CONFIG_DIR/kustomization.yaml"

## Generate main kustomization.yaml to be able to run `make kustomize` that includes the generated config
sed -E 's,^# ,,g' templates/kustomization.yaml > kustomization.yaml

## Generate volumeMounts patch
echo "$CONFIG_FILES" | yq --from-file templates/volume-mounts.yq > "$CONFIG_DIR/volume-mounts.patch.yaml"

## Generate ingress patch
STALWART_HOST=$(yq '.macros.host' "$STALWART_CONFIG_DIR/config.toml")
export STALWART_HOST
yq '.[0].value = env(STALWART_HOST)' examples/ingress.patch.yaml > "$CONFIG_DIR/ingress.patch.yaml"

## Copy other config files and patches
cp examples/litestream.yaml examples/statefulset.patch.yaml "$CONFIG_DIR"
